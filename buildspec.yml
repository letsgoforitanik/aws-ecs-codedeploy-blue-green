version: 0.2

phases:
    pre_build:
        commands:
            - echo Logging in to Amazon ECR...
            - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $REGISTRY_URI
            - REPOSITORY_URI=$REGISTRY_URI/prime-api
            - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
    build:
        commands:
            - echo Build started on `date`
            - echo Building the Docker image...
            - docker build -t prime-api:latest .
            - docker tag prime-api:latest $REPOSITORY_URI:$COMMIT_HASH
    post_build:
        commands:
            - echo Build completed on `date`
            - echo Pushing the Docker image...
            - docker push $REPOSITORY_URI:$COMMIT_HASH
            - TASK_DEFINITION_ARN=$(aws ecs describe-services --cluster prime-api-cluster --services prime-api-service --query 'services[*].taskDefinition' --output text)
            - echo $TASK_DEFINITION_ARN

artifacts:
    files: appspec.yml
